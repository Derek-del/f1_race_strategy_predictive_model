<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>F1 Strategy 2025</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #040404;
      --bg-soft: #0a0a0a;
      --surface: rgba(17, 17, 17, 0.72);
      --surface-2: rgba(12, 12, 12, 0.9);
      --line: rgba(255, 255, 255, 0.08);
      --line-strong: rgba(255, 255, 255, 0.2);
      --ink: #f5f5f5;
      --muted: #a6a6a6;
      --accent: #ff3147;
      --accent-soft: rgba(255, 49, 71, 0.24);
      --good: #63d49a;
      --warn: #f4c16f;
      --bad: #f67480;
      --radius-lg: 24px;
      --radius-md: 18px;
      --radius-sm: 12px;
      --shadow: 0 22px 44px rgba(0, 0, 0, 0.4);
      --ease: cubic-bezier(.22,.8,.2,1);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 24px;
      font-family: "Sora", "Helvetica Neue", Helvetica, Arial, sans-serif;
      color: var(--ink);
      background:
        radial-gradient(90% 90% at 90% -10%, rgba(255, 49, 71, 0.2) 0%, transparent 52%),
        radial-gradient(80% 70% at -10% 0%, rgba(255, 255, 255, 0.05) 0%, transparent 42%),
        linear-gradient(170deg, #020202 0%, #050505 60%, #020202 100%);
      min-height: 100vh;
      letter-spacing: 0.01em;
      -webkit-font-smoothing: antialiased;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
      background-size: 42px 42px;
      opacity: 0.32;
      pointer-events: none;
      z-index: 0;
      mask-image: radial-gradient(circle at center, black 45%, transparent 100%);
      -webkit-mask-image: radial-gradient(circle at center, black 45%, transparent 100%);
    }

    .car-bg {
      position: fixed;
      right: -220px;
      top: 56px;
      width: min(1000px, 88vw);
      opacity: 0.2;
      z-index: 0;
      pointer-events: none;
      filter: drop-shadow(0 0 22px rgba(255, 49, 71, 0.35));
      animation: drift 16s ease-in-out infinite;
    }

    .car-bg svg {
      width: 100%;
      height: auto;
      display: block;
    }

    .site {
      max-width: 1220px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
      display: grid;
      gap: 16px;
    }

    .hero {
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      background: linear-gradient(160deg, rgba(14, 14, 14, 0.92) 0%, rgba(9, 9, 9, 0.86) 100%);
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
      animation: rise 560ms var(--ease) both;
    }

    .hero::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(120deg, transparent 20%, rgba(255, 49, 71, 0.08) 50%, transparent 80%);
      transform: translateX(-50%);
      animation: sweep 5.8s ease-in-out infinite;
      pointer-events: none;
    }

    .hero-inner {
      display: grid;
      grid-template-columns: 1.2fr auto;
      gap: 16px;
      padding: 22px;
      align-items: start;
    }

    .eyebrow {
      margin: 0 0 10px 0;
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #e6b9bf;
    }

    .title {
      margin: 0 0 8px 0;
      font-size: clamp(30px, 4.2vw, 52px);
      line-height: 1.02;
      font-weight: 700;
      max-width: 840px;
      letter-spacing: -0.02em;
      text-wrap: balance;
    }

    .title span {
      color: #ff6a7b;
      text-shadow: 0 0 16px rgba(255, 49, 71, 0.3);
    }

    .sub {
      margin: 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }

    .meta-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 14px;
    }

    .pill {
      border: 1px solid var(--line);
      border-radius: 999px;
      background: rgba(16, 16, 16, 0.85);
      color: #d3d3d3;
      padding: 4px 11px;
      font-size: 11px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .actions {
      display: grid;
      gap: 8px;
      min-width: 210px;
    }

    .btn {
      border: 1px solid var(--line);
      background: rgba(18, 18, 18, 0.92);
      color: #f2f2f2;
      border-radius: 12px;
      font-size: 12px;
      padding: 10px 12px;
      cursor: pointer;
      transition: transform 180ms var(--ease), border-color 180ms var(--ease), background-color 180ms var(--ease);
      position: relative;
      overflow: hidden;
    }

    .btn:hover {
      border-color: var(--line-strong);
      transform: translateY(-1px);
      background: rgba(24, 24, 24, 0.96);
    }

    .btn.primary {
      border-color: rgba(255, 49, 71, 0.55);
      background: linear-gradient(120deg, rgba(255, 49, 71, 0.24), rgba(255, 49, 71, 0.06));
      color: #ffeef1;
    }

    .btn.warn {
      border-color: rgba(244, 193, 111, 0.4);
      color: #f7d8a2;
    }

    .ripple {
      position: absolute;
      border-radius: 50%;
      transform: scale(0);
      background: rgba(255, 255, 255, 0.35);
      pointer-events: none;
      animation: ripple 620ms cubic-bezier(.2,.7,.2,1) forwards;
    }

    .tabs-wrap {
      padding: 0 22px 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 5px;
      background: rgba(8, 8, 8, 0.86);
    }

    .tab {
      border: 1px solid transparent;
      background: transparent;
      color: #bcbcbc;
      border-radius: 999px;
      font-size: 12px;
      padding: 8px 13px;
      cursor: pointer;
      transition: all 180ms var(--ease);
      position: relative;
      overflow: hidden;
    }

    .tab:hover {
      color: #f2f2f2;
      border-color: rgba(255, 255, 255, 0.18);
    }

    .tab.active {
      border-color: rgba(255, 49, 71, 0.45);
      background: rgba(255, 49, 71, 0.16);
      color: #fff2f4;
    }

    .route-hint {
      margin: 0;
      font-size: 12px;
      color: var(--muted);
    }

    .page {
      display: none;
      opacity: 0;
      transform: translateY(10px);
    }

    .page.active {
      display: block;
      animation: rise 320ms var(--ease) forwards;
    }

    .landing {
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      background: linear-gradient(150deg, rgba(15, 15, 15, 0.92) 0%, rgba(8, 8, 8, 0.9) 100%);
      padding: 28px;
      margin-bottom: 14px;
      position: relative;
      overflow: hidden;
    }

    .landing::after {
      content: "";
      position: absolute;
      width: 360px;
      height: 360px;
      border-radius: 999px;
      right: -130px;
      top: -120px;
      background: radial-gradient(circle, rgba(255,49,71,0.26) 0%, rgba(255,49,71,0) 72%);
      pointer-events: none;
      animation: breathe 7s ease-in-out infinite;
    }

    .landing h2 {
      margin: 0 0 10px 0;
      font-size: clamp(26px, 4vw, 40px);
      letter-spacing: -0.02em;
      max-width: 760px;
      text-wrap: balance;
    }

    .landing p {
      margin: 0 0 16px 0;
      max-width: 760px;
      color: #b9b9b9;
      line-height: 1.6;
      font-size: 14px;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      margin-bottom: 12px;
    }

    .card {
      border: 1px solid var(--line);
      border-radius: var(--radius-md);
      background: rgba(14, 14, 14, 0.88);
      padding: 12px;
      opacity: 0;
      transform: translateY(8px);
    }

    .card.reveal { animation: rise 320ms var(--delay, 0ms) var(--ease) forwards; }

    .label { margin: 0 0 6px 0; color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: 0.06em; }
    .value { margin: 0; font-size: 21px; font-weight: 600; }

    .grid-2 {
      display: grid;
      grid-template-columns: 1.05fr 1.95fr;
      gap: 12px;
    }

    .panel {
      border: 1px solid var(--line);
      border-radius: var(--radius-md);
      background: rgba(10, 10, 10, 0.9);
      padding: 14px;
    }

    .panel h3 {
      margin: 0 0 10px 0;
      font-size: 15px;
      letter-spacing: 0.02em;
    }

    .status-good { color: var(--good); font-weight: 600; }
    .status-warn { color: var(--warn); font-weight: 600; }
    .status-bad { color: var(--bad); font-weight: 600; }

    .bar-row {
      display: grid;
      grid-template-columns: 160px 1fr 54px;
      gap: 8px;
      align-items: center;
      margin: 8px 0;
      font-size: 12px;
      opacity: 0;
      transform: translateX(-6px);
    }

    .bar-row.reveal { animation: slide 360ms var(--delay, 0ms) var(--ease) forwards; }

    .bar {
      height: 8px;
      border-radius: 999px;
      background: #1b1b1b;
      overflow: hidden;
    }

    .bar span {
      display: block;
      width: 0%;
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #b7283a 0%, #ff3147 100%);
      transition: width 860ms var(--ease);
      box-shadow: 0 0 12px rgba(255,49,71,0.35);
    }

    .spark {
      width: 100%;
      height: 86px;
      border: 1px solid #202020;
      border-radius: 10px;
      background: #0a0a0a;
      margin-top: 10px;
      display: block;
    }

    .controls {
      border: 1px solid var(--line);
      border-radius: var(--radius-md);
      background: rgba(10, 10, 10, 0.92);
      padding: 12px;
      margin-bottom: 10px;
      display: grid;
      gap: 10px;
    }

    .row {
      display: grid;
      grid-template-columns: 1.5fr 0.7fr 1fr auto;
      gap: 10px;
      align-items: center;
    }

    .field { display: grid; gap: 4px; }

    .field label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    input[type='search'], select, input[type='range'] {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #111;
      color: var(--ink);
      font-size: 13px;
      padding: 8px 9px;
      outline: none;
    }

    input[type='search']:focus, select:focus {
      border-color: rgba(255,49,71,0.6);
      box-shadow: 0 0 0 3px rgba(255,49,71,0.2);
    }

    .table-wrap {
      border: 1px solid var(--line);
      border-radius: var(--radius-md);
      background: rgba(9, 9, 9, 0.92);
      padding: 12px;
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .hint { margin: 0; font-size: 12px; color: var(--muted); }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th, td {
      text-align: left;
      padding: 10px 8px;
      border-bottom: 1px solid #1d1d1d;
      vertical-align: top;
    }

    thead th { background: #101010; color: #e8e8e8; }

    .th-btn {
      border: 0;
      background: transparent;
      color: inherit;
      font: inherit;
      cursor: pointer;
      padding: 0;
      position: relative;
      overflow: hidden;
    }

    tbody tr {
      opacity: 0;
      transform: translateY(7px);
      cursor: pointer;
      transition: background-color 160ms ease;
    }

    tbody tr.reveal { animation: rise 360ms var(--delay, 0ms) var(--ease) forwards; }
    tbody tr:hover { background: rgba(255,49,71,0.08); }

    .mono { font-family: "SFMono-Regular", Menlo, monospace; color: #bdbdbd; font-size: 11px; }

    .sim-grid {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 12px;
    }

    .sim-row { display: grid; gap: 8px; margin: 10px 0; }

    .sim-metric {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 8px;
      padding: 8px 0;
      border-bottom: 1px dashed #242424;
      font-size: 13px;
    }

    .sim-metric strong { font-size: 17px; }

    .integrity-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .list { margin: 0; padding-left: 18px; color: #dddddd; font-size: 13px; }

    .hash-list { max-height: 330px; overflow: auto; display: grid; gap: 8px; }

    .hash-item {
      border: 1px solid #242424;
      border-radius: var(--radius-sm);
      padding: 8px;
      background: #0d0d0d;
      display: grid;
      gap: 7px;
    }

    .hash-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 12px;
    }

    .hash-line code {
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: #cbcbcb;
    }

    .raw {
      width: 100%;
      max-height: 340px;
      overflow: auto;
      margin-top: 8px;
      border: 1px solid #252525;
      border-radius: 10px;
      background: #0a0a0a;
      color: #d0d0d0;
      font-size: 11px;
      padding: 10px;
      display: none;
    }

    .raw.show { display: block; }

    .drawer-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.58);
      opacity: 0;
      pointer-events: none;
      transition: opacity 180ms ease;
      z-index: 18;
    }

    .drawer-backdrop.show {
      opacity: 1;
      pointer-events: auto;
    }

    .drawer {
      position: fixed;
      top: 0;
      right: 0;
      height: 100%;
      width: min(480px, 100%);
      background: rgba(8, 8, 8, 0.98);
      border-left: 1px solid #232323;
      transform: translateX(102%);
      transition: transform 300ms var(--ease);
      z-index: 20;
      padding: 14px;
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 10px;
      box-shadow: -20px 0 36px rgba(0,0,0,0.5);
    }

    .drawer.open { transform: translateX(0); }

    .drawer-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .drawer-body {
      overflow: auto;
      font-size: 13px;
      color: #e4e4e4;
      display: grid;
      gap: 8px;
    }

    .drawer-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .kv {
      border: 1px solid #222;
      border-radius: var(--radius-sm);
      background: #111;
      padding: 8px;
    }

    .kv p { margin: 0; }

    .kv .k {
      color: var(--muted);
      font-size: 10px;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .kv .v {
      color: #f2f2f2;
      font-size: 14px;
      font-weight: 600;
      line-height: 1.3;
    }

    .tag {
      display: inline-block;
      border: 1px solid #282828;
      border-radius: 999px;
      padding: 4px 9px;
      font-size: 11px;
      color: #d8d8d8;
      margin-right: 6px;
      margin-bottom: 6px;
    }

    @keyframes rise {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slide {
      from { opacity: 0; transform: translateX(-7px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes sweep {
      0%, 15% { opacity: 0; transform: translateX(-55%); }
      35% { opacity: 1; }
      70%, 100% { opacity: 0; transform: translateX(55%); }
    }

    @keyframes ripple {
      0% { transform: scale(0); opacity: 0.4; }
      100% { transform: scale(4.4); opacity: 0; }
    }

    @keyframes breathe {
      0%, 100% { transform: scale(0.95); opacity: 0.45; }
      50% { transform: scale(1.08); opacity: 0.7; }
    }

    @keyframes drift {
      0%, 100% { transform: translateX(0); }
      50% { transform: translateX(-18px); }
    }

    @media (max-width: 980px) {
      .hero-inner {
        grid-template-columns: 1fr;
      }

      .actions {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }

      .grid-2, .sim-grid, .integrity-grid, .row {
        grid-template-columns: 1fr;
      }

      .tabs-wrap {
        flex-direction: column;
        align-items: stretch;
      }

      .tabs {
        width: 100%;
        justify-content: space-between;
      }

      .tab {
        flex: 1;
        text-align: center;
      }

      .bar-row {
        grid-template-columns: 120px 1fr 48px;
      }
    }

    @media (max-width: 760px) {
      body {
        padding: 12px;
      }

      .landing,
      .hero-inner,
      .tabs-wrap {
        padding-left: 14px;
        padding-right: 14px;
      }

      .actions {
        grid-template-columns: 1fr;
      }

      .car-bg {
        top: 80px;
        right: -280px;
        width: 1100px;
        opacity: 0.16;
      }

      .drawer-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation: none !important;
        transition: none !important;
      }

      .hero, .page, .card, .bar-row, tbody tr {
        opacity: 1 !important;
        transform: none !important;
      }
    }
  </style>
</head>
<body>
  <div class="car-bg" aria-hidden="true">
    <svg viewBox="0 0 1400 420" fill="none" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="carFill" x1="70" y1="120" x2="1260" y2="300" gradientUnits="userSpaceOnUse">
          <stop stop-color="#8d101f"/>
          <stop offset="0.52" stop-color="#ff3147"/>
          <stop offset="1" stop-color="#6b0b16"/>
        </linearGradient>
      </defs>
      <path d="M90 270C160 247 238 235 316 236H420L514 196H668L760 146H945L1048 198H1200C1236 199 1269 217 1287 247L1318 292H1214L1186 262H1016L980 304H816L780 262H572L540 304H386L356 264H214L162 294H84L90 270Z" fill="url(#carFill)"/>
      <path d="M90 270C160 247 238 235 316 236H420L514 196H668L760 146H945L1048 198H1200C1236 199 1269 217 1287 247L1318 292H1214L1186 262H1016L980 304H816L780 262H572L540 304H386L356 264H214L162 294H84L90 270Z" stroke="#ff8593" stroke-opacity="0.45" stroke-width="2"/>
      <circle cx="470" cy="316" r="42" fill="#141414"/>
      <circle cx="916" cy="316" r="42" fill="#141414"/>
    </svg>
  </div>

  <div class="site">
    <header class="hero">
      <div class="hero-inner">
        <div>
          <p class="eyebrow">F1 STRATEGY LAB</p>
          <h1 class="title">Strategy for the <span>2025 season</span></h1>
          <p class="sub" id="metaLine">Loading run data...</p>
          <div class="meta-pills">
            <span class="pill" id="modePill">mode</span>
            <span class="pill" id="pathPill">path</span>
          </div>
        </div>
        <div class="actions">
          <button class="btn primary" id="jumpStrategy">Explore race strategy</button>
          <button class="btn" id="downloadCsv">Download CSV</button>
          <button class="btn" id="downloadJson">Download JSON</button>
        </div>
      </div>
      <div class="tabs-wrap">
        <nav class="tabs" id="tabs">
          <button class="tab active" data-route="overview">Home</button>
          <button class="tab" data-route="races">Race Strategy</button>
          <button class="tab" data-route="simulator">Scenario Lab</button>
          <button class="tab" data-route="integrity">Data Health</button>
        </nav>
        <p class="route-hint">Track-level strategy plans with fallback options for race-day uncertainty.</p>
      </div>
    </header>

    <main>
      <section class="page active" id="page-overview">
        <section class="landing">
          <h2>Build race-day decisions from practice, qualifying and contingency signals.</h2>
          <p>
            This control panel turns model outputs into strategy actions: which tyre to start on, when to pit,
            and what backup plans to activate if weather shifts, reliability drops, or race incidents occur.
          </p>
          <button class="btn primary" id="jumpStrategySecondary">Open race strategy table</button>
        </section>

        <section class="cards" id="kpiCards"></section>

        <section class="grid-2">
          <div class="panel">
            <h3>Round Validation</h3>
            <p id="roundStatus"></p>
            <p class="sub" id="roundDetail"></p>
            <svg class="spark" id="pointsSpark" viewBox="0 0 600 90" preserveAspectRatio="none"></svg>
          </div>
          <div class="panel">
            <h3>Top Rounds by Strategy Score</h3>
            <div id="topRounds"></div>
          </div>
        </section>
      </section>

      <section class="page" id="page-races">
        <section class="controls">
          <div class="row">
            <div class="field">
              <label for="searchInput">Search</label>
              <input id="searchInput" type="search" placeholder="Event, strategy, fallback trigger..." />
            </div>
            <div class="field">
              <label for="stopFilter">Stops</label>
              <select id="stopFilter">
                <option value="all">All</option>
                <option value="1">1 stop</option>
                <option value="2">2 stops</option>
              </select>
            </div>
            <div class="field">
              <label for="minWin">Min win probability</label>
              <input id="minWin" type="range" min="0" max="1" step="0.01" value="0" />
            </div>
            <div>
              <button class="btn warn" id="resetFilters">Reset</button>
            </div>
          </div>
          <p class="hint" id="filterState">No filters active.</p>
        </section>

        <section class="table-wrap">
          <div class="table-header">
            <strong>Race Strategy Table (click row for full primary + fallback plan)</strong>
            <p class="hint" id="tableCount">0 rows</p>
          </div>
          <div style="overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th><button class="th-btn" data-sort="event_name">Event</button></th>
                  <th><button class="th-btn" data-sort="strategy_plan">Primary Plan</button></th>
                  <th><button class="th-btn" data-sort="stops">Stops</button></th>
                  <th>Start Tyre</th>
                  <th>First Pit</th>
                  <th><button class="th-btn" data-sort="win_probability">Win Prob</button></th>
                  <th><button class="th-btn" data-sort="strategy_score">Score</button></th>
                </tr>
              </thead>
              <tbody id="raceRows"></tbody>
            </table>
          </div>
        </section>
      </section>

      <section class="page" id="page-simulator">
        <section class="sim-grid">
          <div class="panel">
            <h3>Interactive Championship What-If</h3>
            <p class="sub">Adjust assumptions to simulate alternate title probability outcomes.</p>
            <div class="sim-row">
              <label for="driverDelta">Driver form adjustment: <strong id="driverDeltaValue">0 pp</strong></label>
              <input id="driverDelta" type="range" min="-30" max="30" step="1" value="0" />
            </div>
            <div class="sim-row">
              <label for="teammateFactor">Team synergy adjustment: <strong id="teammateFactorValue">0 pp</strong></label>
              <input id="teammateFactor" type="range" min="-30" max="30" step="1" value="0" />
            </div>
            <p class="hint">Adjustments are in percentage points of title confidence (pp).</p>
          </div>
          <div class="panel">
            <h3>Projected Outcome</h3>
            <div id="simMetrics"></div>
          </div>
        </section>
      </section>

      <section class="page" id="page-integrity">
        <section class="integrity-grid">
          <div class="panel">
            <h3>Run Validation</h3>
            <ul class="list" id="integritySummary"></ul>
            <button class="btn" id="toggleManifest">Toggle Raw Manifest</button>
            <pre class="raw" id="manifestRaw"></pre>
          </div>
          <div class="panel">
            <h3>Checksums (click copy)</h3>
            <div class="hash-list" id="hashList"></div>
          </div>
        </section>
      </section>
    </main>
  </div>

  <div class="drawer-backdrop" id="drawerBackdrop"></div>
  <aside class="drawer" id="raceDrawer">
    <div class="drawer-head">
      <strong id="drawerTitle">Race Detail</strong>
      <button class="btn" id="closeDrawer">Close</button>
    </div>
    <div class="drawer-body" id="drawerBody"></div>
  </aside>

  <script>
    const routes = ['overview', 'races', 'simulator', 'integrity'];
    const state = {
      payload: null,
      sortKey: 'strategy_score',
      sortDir: 'desc',
      filteredRows: []
    };

    const fmt = (v, n=3) => (v === null || v === undefined || Number.isNaN(v)) ? '-' : Number(v).toFixed(n);
    const pct = (v) => (v === null || v === undefined || Number.isNaN(v)) ? '-' : `${(Number(v) * 100).toFixed(1)}%`;
    const sigmoid = (x) => 1 / (1 + Math.exp(-x));
    const logit = (p) => Math.log(p / (1 - p));
    const clamp = (x, a, b) => Math.min(Math.max(x, a), b);
    const supportsViewTransition = typeof document.startViewTransition === 'function';

    function safeText(value) {
      return (value === null || value === undefined) ? '-' : String(value);
    }

    function routeFromHash() {
      const route = (window.location.hash || '').replace('#', '');
      if (routes.includes(route)) return route;
      const byPath = window.location.pathname.replace('/', '');
      if (byPath === 'home') return 'overview';
      if (routes.includes(byPath)) return byPath;
      return 'overview';
    }

    function animateRouteSwap(fn) {
      if (supportsViewTransition) {
        document.startViewTransition(fn);
        return;
      }
      fn();
    }

    function setRoute(route) {
      const finalRoute = routes.includes(route) ? route : 'overview';
      if (window.location.hash !== `#${finalRoute}`) {
        window.location.hash = finalRoute;
      } else {
        animateRouteSwap(() => renderRoute(finalRoute));
      }
    }

    function renderRoute(route) {
      for (const page of document.querySelectorAll('.page')) {
        page.classList.toggle('active', page.id === `page-${route}`);
      }
      for (const tab of document.querySelectorAll('.tab')) {
        tab.classList.toggle('active', tab.dataset.route === route);
      }
    }

    function spawnRipple(target, clientX, clientY) {
      const rect = target.getBoundingClientRect();
      const size = Math.max(rect.width, rect.height) * 1.1;
      const ripple = document.createElement('span');
      ripple.className = 'ripple';
      ripple.style.width = `${size}px`;
      ripple.style.height = `${size}px`;
      ripple.style.left = `${clientX - rect.left - size / 2}px`;
      ripple.style.top = `${clientY - rect.top - size / 2}px`;
      target.appendChild(ripple);
      ripple.addEventListener('animationend', () => ripple.remove(), { once: true });
    }

    function createCard(label, value, idx) {
      const card = document.createElement('div');
      card.className = 'card reveal';
      card.style.setProperty('--delay', `${70 + idx * 40}ms`);
      card.innerHTML = `<p class='label'>${label}</p><p class='value'>${value}</p>`;
      return card;
    }

    function renderOverview(payload) {
      const k = payload.kpis || {};
      const cards = document.getElementById('kpiCards');
      cards.innerHTML = '';
      const defs = [
        ['Training Rows', k.training_rows ?? '-'],
        ['Inference Rows', k.inference_rows ?? '-'],
        ['MAE', fmt(k.mae, 3)],
        ['RMSE', fmt(k.rmse, 3)],
        ['Driver Title Prob', pct(k.driver_title_probability)],
        ['Constructors Title Prob', pct(k.constructors_title_probability)]
      ];
      defs.forEach((d, i) => cards.appendChild(createCard(d[0], d[1], i)));

      const rv = payload.round_validation || {};
      const status = document.getElementById('roundStatus');
      const all = rv.all_rounds_present;
      if (all === true) {
        status.className = 'status-good';
        status.textContent = 'All rounds present';
      } else if (all === false) {
        status.className = 'status-bad';
        status.textContent = 'Coverage gap detected';
      } else {
        status.className = 'status-warn';
        status.textContent = 'Validation unavailable';
      }
      document.getElementById('roundDetail').textContent =
        `Expected: ${rv.expected_rounds ?? '-'} | Produced: ${rv.produced_rounds ?? '-'} | Missing: ${(rv.missing_events || []).length}`;

      const top = document.getElementById('topRounds');
      top.innerHTML = '';
      const topRows = payload.top_rounds || [];
      const maxScore = Math.max(...topRows.map(r => Number(r.strategy_score || 0)), 1);
      topRows.forEach((r, i) => {
        const val = Number(r.strategy_score || 0);
        const width = Math.max(4, Math.round((val / maxScore) * 100));
        const row = document.createElement('div');
        row.className = 'bar-row reveal';
        row.style.setProperty('--delay', `${110 + (i * 65)}ms`);
        row.innerHTML = `
          <span>${safeText(r.event_name)}</span>
          <div class='bar'><span data-width='${width}%'></span></div>
          <span>${fmt(val, 2)}</span>
        `;
        top.appendChild(row);
        const fill = row.querySelector('span[data-width]');
        requestAnimationFrame(() => { fill.style.width = fill.dataset.width || '0%'; });
      });

      renderSparkline(payload.strategy_rows || []);
    }

    function renderSparkline(rows) {
      const svg = document.getElementById('pointsSpark');
      if (!rows.length) {
        svg.innerHTML = '';
        return;
      }
      const pts = rows.map(r => Number(r.strategy_score || 0));
      const min = Math.min(...pts);
      const max = Math.max(...pts);
      const span = (max - min) || 1;
      const width = 600;
      const height = 90;
      const pad = 10;
      const toXY = (v, i) => {
        const x = pad + (i * ((width - pad * 2) / Math.max(rows.length - 1, 1)));
        const y = height - pad - (((v - min) / span) * (height - pad * 2));
        return [x, y];
      };
      const coords = pts.map((v, i) => toXY(v, i));
      const line = coords.map((c, i) => `${i === 0 ? 'M' : 'L'}${c[0].toFixed(2)},${c[1].toFixed(2)}`).join(' ');
      const area = `${line} L${coords[coords.length - 1][0]},${height - pad} L${coords[0][0]},${height - pad} Z`;
      svg.innerHTML = `
        <defs>
          <linearGradient id='g1' x1='0' y1='0' x2='0' y2='1'>
            <stop offset='0%' stop-color='rgba(255,49,71,0.45)'/>
            <stop offset='100%' stop-color='rgba(255,49,71,0)'/>
          </linearGradient>
        </defs>
        <path d='${area}' fill='url(#g1)'></path>
        <path d='${line}' fill='none' stroke='#ff3d53' stroke-width='2.2'></path>
      `;
    }

    function compare(a, b, key) {
      const av = a[key];
      const bv = b[key];
      const an = Number(av);
      const bn = Number(bv);
      if (!Number.isNaN(an) && !Number.isNaN(bn)) return an - bn;
      return safeText(av).localeCompare(safeText(bv));
    }

    function filteredRaceRows() {
      const rows = state.payload.strategy_rows || [];
      const search = document.getElementById('searchInput').value.trim().toLowerCase();
      const stop = document.getElementById('stopFilter').value;
      const minWin = Number(document.getElementById('minWin').value || 0);
      const out = rows.filter(r => {
        const blob = `${safeText(r.event_name)} ${safeText(r.best_strategy)} ${safeText(r.strategy_plan)} ${safeText(r.compounds)} ${safeText(r.fallback_2_plan)} ${safeText(r.fallback_3_plan)} ${safeText(r.fallback_2_trigger)} ${safeText(r.fallback_3_trigger)}`.toLowerCase();
        const okSearch = !search || blob.includes(search);
        const okStop = stop === 'all' || String(Math.round(Number(r.stops || 0))) === stop;
        const okWin = Number(r.win_probability || 0) >= minWin;
        return okSearch && okStop && okWin;
      });
      out.sort((a, b) => {
        const base = compare(a, b, state.sortKey);
        return state.sortDir === 'asc' ? base : -base;
      });
      return out;
    }

    function renderRaceTable() {
      const rows = filteredRaceRows();
      state.filteredRows = rows;
      const body = document.getElementById('raceRows');
      body.innerHTML = '';
      rows.forEach((r, i) => {
        const tr = document.createElement('tr');
        tr.className = 'reveal';
        tr.style.setProperty('--delay', `${Math.min(i * 12, 240)}ms`);
        tr.dataset.index = String(i);
        tr.innerHTML = `
          <td>${safeText(r.event_name)}</td>
          <td>${safeText(r.strategy_plan || r.best_strategy)}</td>
          <td>${fmt(r.stops, 0)}</td>
          <td>${safeText(r.start_compound || '-')}</td>
          <td>${r.first_pit_lap == null ? '-' : `L${fmt(r.first_pit_lap, 0)}`}</td>
          <td>${pct(r.win_probability)}</td>
          <td>${fmt(r.strategy_score, 2)}</td>
        `;
        body.appendChild(tr);
      });
      document.getElementById('tableCount').textContent = `${rows.length} rows`;
      const minWin = Number(document.getElementById('minWin').value || 0);
      const stop = document.getElementById('stopFilter').value;
      const parts = [];
      if (minWin > 0) parts.push(`min win ${pct(minWin)}`);
      if (stop !== 'all') parts.push(`${stop} stop`);
      if (document.getElementById('searchInput').value.trim()) parts.push('search active');
      document.getElementById('filterState').textContent = parts.length ? parts.join(' | ') : 'No filters active.';
    }

    function openDrawer(row) {
      if (!row) return;
      document.getElementById('drawerTitle').textContent = safeText(row.event_name);
      const body = document.getElementById('drawerBody');
      body.innerHTML = `
        <div>
          <span class='tag'>${safeText(row.team)}</span>
          <span class='tag'>${safeText(row.driver)}</span>
          <span class='tag'>${safeText(row.start_compound || row.compounds)}</span>
        </div>
        <div class='drawer-grid'>
          <div class='kv'><p class='k'>Best Strategy</p><p class='v mono'>${safeText(row.best_strategy)}</p></div>
          <div class='kv'><p class='k'>Primary Plan</p><p class='v'>${safeText(row.strategy_plan)}</p></div>
          <div class='kv'><p class='k'>Stops</p><p class='v'>${fmt(row.stops, 0)}</p></div>
          <div class='kv'><p class='k'>First Pit Lap</p><p class='v'>${row.first_pit_lap == null ? '-' : `L${fmt(row.first_pit_lap, 0)}`}</p></div>
          <div class='kv'><p class='k'>Pit Laps</p><p class='v'>${safeText(row.pit_laps)}</p></div>
          <div class='kv'><p class='k'>Win Probability</p><p class='v'>${pct(row.win_probability)}</p></div>
          <div class='kv'><p class='k'>Strategy Score</p><p class='v'>${fmt(row.strategy_score, 2)}</p></div>
          <div class='kv'><p class='k'>Robustness Window</p><p class='v'>${fmt(row.robustness_window, 2)}s</p></div>
          <div class='kv'><p class='k'>Fallback #2</p><p class='v'>${safeText(row.fallback_2_plan || row.fallback_2_strategy)}</p></div>
          <div class='kv'><p class='k'>Fallback #2 Trigger</p><p class='v'>${safeText(row.fallback_2_trigger)}</p></div>
          <div class='kv'><p class='k'>Fallback #3</p><p class='v'>${safeText(row.fallback_3_plan || row.fallback_3_strategy)}</p></div>
          <div class='kv'><p class='k'>Fallback #3 Trigger</p><p class='v'>${safeText(row.fallback_3_trigger)}</p></div>
        </div>
      `;
      document.getElementById('drawerBackdrop').classList.add('show');
      document.getElementById('raceDrawer').classList.add('open');
    }

    function closeDrawer() {
      document.getElementById('drawerBackdrop').classList.remove('show');
      document.getElementById('raceDrawer').classList.remove('open');
    }

    function renderSimulator() {
      const champ = state.payload.championship || {};
      const baseDriverProb = clamp(Number(champ.driver_title_probability || 0), 0.001, 0.999);
      const baseConstructorsProb = clamp(Number(champ.constructors_title_probability || 0), 0.001, 0.999);
      const driverDeltaPP = Number(document.getElementById('driverDelta').value || 0);
      const teamDeltaPP = Number(document.getElementById('teammateFactor').value || 0);

      const driverProb = sigmoid(logit(baseDriverProb) + driverDeltaPP / 9.5);
      const constructorsProb = sigmoid(logit(baseConstructorsProb) + (driverDeltaPP + teamDeltaPP) / 11.0);
      const titleStrength = (driverProb * 0.55 + constructorsProb * 0.45) * 100.0;

      document.getElementById('driverDeltaValue').textContent = `${driverDeltaPP > 0 ? '+' : ''}${driverDeltaPP} pp`;
      document.getElementById('teammateFactorValue').textContent = `${teamDeltaPP > 0 ? '+' : ''}${teamDeltaPP} pp`;

      const sim = document.getElementById('simMetrics');
      sim.innerHTML = `
        <div class='sim-metric'><span>Baseline driver title probability</span><strong>${pct(baseDriverProb)}</strong></div>
        <div class='sim-metric'><span>Baseline constructors title probability</span><strong>${pct(baseConstructorsProb)}</strong></div>
        <div class='sim-metric'><span>Scenario driver title probability</span><strong>${pct(driverProb)}</strong></div>
        <div class='sim-metric'><span>Scenario constructors title probability</span><strong>${pct(constructorsProb)}</strong></div>
        <div class='sim-metric'><span>Combined title strength index</span><strong>${fmt(titleStrength, 1)}</strong></div>
      `;
    }

    function renderIntegrity(payload) {
      const rv = payload.round_validation || {};
      const src = payload.source || {};
      const summary = document.getElementById('integritySummary');
      summary.innerHTML = '';
      const items = [
        `Mode: ${safeText(src.mode)}`,
        `Manifest present: ${src.manifest_present ? 'yes' : 'no'}`,
        `Expected rounds: ${safeText(rv.expected_rounds)}`,
        `Produced rounds: ${safeText(rv.produced_rounds)}`,
        `Missing events: ${(rv.missing_events || []).length}`,
        `Extra events: ${(rv.extra_events || []).length}`
      ];
      items.forEach(text => {
        const li = document.createElement('li');
        li.textContent = text;
        summary.appendChild(li);
      });

      const hashes = (payload.manifest && payload.manifest.sha256) ? payload.manifest.sha256 : {};
      const list = document.getElementById('hashList');
      list.innerHTML = '';
      const entries = Object.entries(hashes);
      if (!entries.length) {
        const empty = document.createElement('p');
        empty.className = 'hint';
        empty.textContent = 'No manifest checksum data found. Run a locked snapshot to populate this.';
        list.appendChild(empty);
      } else {
        entries.forEach(([name, hash]) => {
          const item = document.createElement('div');
          item.className = 'hash-item';
          item.innerHTML = `
            <div class='hash-line'><strong>${name}</strong><button class='btn' data-copy='${hash}'>Copy</button></div>
            <code>${hash}</code>
          `;
          list.appendChild(item);
        });
      }

      document.getElementById('manifestRaw').textContent = JSON.stringify(payload.manifest || {}, null, 2);
    }

    function toCsv(rows) {
      if (!rows.length) return '';
      const cols = Object.keys(rows[0]);
      const esc = (v) => {
        const s = v === null || v === undefined ? '' : String(v);
        return `"${s.replaceAll('"', '""')}"`;
      };
      const lines = [cols.join(',')];
      rows.forEach(r => lines.push(cols.map(c => esc(r[c])).join(',')));
      return lines.join('\n');
    }

    function downloadText(filename, text, type) {
      const blob = new Blob([text], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function bindEvents() {
      document.getElementById('tabs').addEventListener('click', (event) => {
        const btn = event.target.closest('.tab');
        if (!btn) return;
        setRoute(btn.dataset.route || 'overview');
      });
      window.addEventListener('hashchange', () => {
        animateRouteSwap(() => renderRoute(routeFromHash()));
      });

      document.body.addEventListener('pointerdown', (event) => {
        if (event.button !== 0) return;
        const target = event.target.closest('.btn, .tab, .th-btn');
        if (!target) return;
        spawnRipple(target, event.clientX, event.clientY);
      });

      document.getElementById('jumpStrategy').addEventListener('click', () => setRoute('races'));
      document.getElementById('jumpStrategySecondary').addEventListener('click', () => setRoute('races'));

      document.getElementById('searchInput').addEventListener('input', renderRaceTable);
      document.getElementById('stopFilter').addEventListener('change', renderRaceTable);
      document.getElementById('minWin').addEventListener('input', renderRaceTable);
      document.getElementById('resetFilters').addEventListener('click', () => {
        document.getElementById('searchInput').value = '';
        document.getElementById('stopFilter').value = 'all';
        document.getElementById('minWin').value = '0';
        renderRaceTable();
      });
      document.querySelector('thead').addEventListener('click', (event) => {
        const btn = event.target.closest('.th-btn');
        if (!btn) return;
        const key = btn.dataset.sort;
        if (!key) return;
        if (state.sortKey === key) {
          state.sortDir = state.sortDir === 'asc' ? 'desc' : 'asc';
        } else {
          state.sortKey = key;
          state.sortDir = 'desc';
        }
        renderRaceTable();
      });
      document.getElementById('raceRows').addEventListener('click', (event) => {
        const tr = event.target.closest('tr');
        if (!tr) return;
        const idx = Number(tr.dataset.index);
        openDrawer(state.filteredRows[idx]);
      });
      document.getElementById('closeDrawer').addEventListener('click', closeDrawer);
      document.getElementById('drawerBackdrop').addEventListener('click', closeDrawer);

      document.getElementById('driverDelta').addEventListener('input', renderSimulator);
      document.getElementById('teammateFactor').addEventListener('input', renderSimulator);

      document.getElementById('hashList').addEventListener('click', async (event) => {
        const btn = event.target.closest('button[data-copy]');
        if (!btn) return;
        const val = btn.getAttribute('data-copy') || '';
        try {
          await navigator.clipboard.writeText(val);
          btn.textContent = 'Copied';
          setTimeout(() => { btn.textContent = 'Copy'; }, 900);
        } catch {
          btn.textContent = 'Failed';
        }
      });
      document.getElementById('toggleManifest').addEventListener('click', () => {
        document.getElementById('manifestRaw').classList.toggle('show');
      });

      document.getElementById('downloadCsv').addEventListener('click', () => {
        const rows = state.payload ? (state.payload.strategy_rows || []) : [];
        downloadText('strategy_recommendations_2025.csv', toCsv(rows), 'text/csv;charset=utf-8');
      });
      document.getElementById('downloadJson').addEventListener('click', () => {
        downloadText('strategy_payload.json', JSON.stringify(state.payload || {}, null, 2), 'application/json');
      });
    }

    function renderHeader(payload) {
      const src = payload.source || {};
      document.getElementById('modePill').textContent = `mode: ${safeText(src.mode)}`;
      document.getElementById('pathPill').textContent = safeText(src.path);
      document.getElementById('metaLine').textContent = src.created_at_utc
        ? `Snapshot created (UTC): ${src.created_at_utc}`
        : 'Using reports output (no lock manifest found).';
    }

    async function loadPayload() {
      const sources = ['/api/data', '/data/payload.json'];
      let lastErr = null;
      for (const src of sources) {
        try {
          const res = await fetch(src, { cache: 'no-store' });
          if (!res.ok) throw new Error(`Request failed (${src}): ${res.status}`);
          return await res.json();
        } catch (err) {
          lastErr = err;
        }
      }
      throw lastErr || new Error('No payload source available.');
    }

    async function boot() {
      const payload = await loadPayload();
      state.payload = payload;

      renderHeader(payload);
      renderOverview(payload);
      renderRaceTable();
      renderSimulator();
      renderIntegrity(payload);
      bindEvents();
      renderRoute(routeFromHash());
    }

    boot().catch((err) => {
      document.getElementById('metaLine').textContent = `Failed to load website data: ${err}`;
    });
  </script>
</body>
</html>
